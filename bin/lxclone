#!/bin/bash

if [ "$EUID" -eq 0 ]; then
	LXC_BASE=/var/lib/lxc
else
	LXC_BASE=$HOME/.local/share/lxc
fi

if [ "$1" == "--help" ] || [ "$#" -lt 2 ]; then
	echo "Usage: lxclone [source-name] [target-name]"
	exit 0
fi

BASE_CONTAINER=$1
CONTAINER=$2

if ! lxls | grep "^$BASE_CONTAINER\$" > /dev/null; then
	echo "Base container \"$BASE_CONTAINER\" does not exist"
	exit 1
fi

if lxls | grep "^$CONTAINER\$" > /dev/null; then
	echo "Container with name \"$CONTAINER\" already exists"
	exit 2
fi

LANG=$(echo $BASE_CONTAINER | cut -d- -f1)
RANDOM_MAC=$(hexdump -n5 -e'/5 "00" 5/1 ":%02X"' /dev/urandom)

LXC_CONFIG=$LXC_BASE/$CONTAINER/config
CONTAINER_ROOT=$LXC_BASE/$CONTAINER/rootfs
PROJECT_DIR=$HOME/projects/$LANG/$CONTAINER

lxc-start-ephemeral -o $BASE_CONTAINER -n $CONTAINER --storage-type=dir --union-type overlayfs --keep-data -d
lxc-stop -n $CONTAINER

if [ ! -e "$LXC_CONFIG" ]; then
	echo "Failed cloning"
	exit 1
fi

sed -i "/lxc.utsname = .*/d" $LXC_CONFIG
sed -i "/lxc.network.hwaddr = .*/d" $LXC_CONFIG
sed -i "/lxc.network.0.hwaddr/d" $LXC_CONFIG

echo "lxc.utsname = $CONTAINER" >> $LXC_CONFIG
echo "lxc.network.hwaddr = $RANDOM_MAC" >> $LXC_CONFIG

if [ ! -d "$PROJECT_DIR" ]; then
	mkdir -p $PROJECT_DIR
fi

if [ $LANG == "php" ]; then
	echo "lxc.mount.entry = $PROJECT_DIR $CONTAINER_ROOT/var/www/web none bind,rw 0 0" >> $LXC_CONFIG

	if [ ! -d "$PROJECT_DIR/app" ]; then
		mkdir -p $PROJECT_DIR/app/.idea
		mkdir -p $PROJECT_DIR/error-pages

		SERVER_UUID=$(uuidgen)
		INTERPRETER_UUID=$(uuidgen)
		generate-config phpstorm-add-server $CONTAINER.lxc $SERVER_UUID
		generate-config phpstorm-add-interpreter $CONTAINER.lxc $SERVER_UUID $INTERPRETER_UUID
		generate-config phpstorm-project $CONTAINER $CONTAINER.lxc $SERVER_UUID $INTERPRETER_UUID $PROJECT_DIR/app/.idea
	fi
elif [ $LANG == "js" ]; then
	echo "lxc.mount.entry = $PROJECT_DIR $CONTAINER_ROOT/home/node/project none bind,rw 0 0" >> $LXC_CONFIG
else
	echo "lxc.mount.entry = $PROJECT_DIR $CONTAINER_ROOT/home/administrator none bind,rw 0 0" >> $LXC_CONFIG
fi
